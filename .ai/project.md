# Исходный контекст проекта

## Цель проекта
- Построить ядро маршрутизатора Beamline, которое принимает запросы через gRPC и NATS, применяет гибкие политики маршрутизации, выбирает провайдеров с учётом сессий, ограничений и сбоев, а затем передаёт назначения в CAF.
- Обеспечить расширяемую цепочку обработчиков (пре-/пост-обработчики и валидацию), расчёт квот и отказоустойчивость (circuit breaker, rate limiting).

## Пользователь
- Сервисы на уровне платформы (например, NestJS API Gateway), которые вызывают `Router.Decide` по gRPC и ожидают детерминированный `RouteDecision`.
- CAF и другие downstream-компоненты, которые подписываются на NATS и обрабатывают `ExecAssignment`/`DecideRequest`.
- Операторы и администраторы, которые управляют политиками через RouterAdmin и наблюдают за метриками/логами.

## Ограничения
1. Стек базируется на Erlang/OTP 26+, компиляция и запуск через `rebar3`.
2. Взаимодействие с внешними системами происходит по gRPC через `grpcbox` и по NATS, причём очередь CAF ожидает JSON-месседжи `DecideRequest`/`ExecAssignment`.
3. Хранение политик и RBAC реализовано в ETS/PostgreSQL с частым обменом, поэтому критична синхронизация при перезапусках.
4. Требуется интеграция с существующими расширениями, которые подключаются через пайплайны pre/post-processor.

## Нефункциональные требования
- **Надёжность**: супервизоры, circuit breaker и rate limiter должны предотвращать каскадные отказа.
- **Производительность**: маршрутизация должна выдерживать высокую пропускную способность от клиентов и CAF, минимально задерживая `RouteDecision`.
- **Обозреваемость**: отдача Prometheus-метрик, аудит изменений политик, мониторинг состояния цепочки обработки.
- **Безопасность и контроль доступа**: RBAC, квоты и аудит операций изменений политик.
- **Расширяемость**: легко вставлять новые политики, расширения и интеграции с CAF.
