# NATS Subjects Specification

## Overview

This document defines all NATS subjects used for Router ↔ CAF integration via JSON messages.

## Subject Naming Convention

Subjects follow hierarchical dot-separated format:
- `beamline.router.v1.*` - Router service subjects
- `caf.exec.assign.v1.*` - CAF execution assignment subjects

## Router Subjects

### Input: Decide Request

**Subject**: `beamline.router.v1.decide`

**Direction**: CAF → Router

**Message Format**: `DecideRequest` (JSON)

**Description**: CAF publishes routing decision requests to this subject.

**Example**:
```json
{
  "version": "1",
  "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242",
  "trace_id": "tr-123",
  "tenant_id": "acme",
  "task": {
    "type": "text.generate",
    "payload_ref": "s3://bucket/key"
  },
  "policy_id": "policy:default",
  "constraints": {
    "max_latency_ms": 2000
  },
  "metadata": {
    "user_id": "u-42"
  },
  "push_assignment": true,
  "assignment_subject": "caf.exec.assign.v1"
}
```

### Output: Decide Response

**Subject**: `beamline.router.v1.decide.reply`

**Direction**: Router → CAF

**Message Format**: `DecideResponse` or `ErrorResponse` (JSON)

**Description**: Router publishes routing decision responses to this subject (reply-inbox pattern).

**Example (Success)**:
```json
{
  "ok": true,
  "decision": {
    "provider_id": "openai:gpt-4o",
    "priority": 50,
    "expected_latency_ms": 850,
    "expected_cost": 0.012,
    "reason": "best_score",
    "policy_id": "policy:default"
  },
  "context": {
    "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242",
    "trace_id": "tr-123"
  }
}
```

**Example (Error)**:
```json
{
  "ok": false,
  "error": {
    "code": "policy_not_found",
    "message": "Policy not found in store",
    "details": {
      "tenant_id": "acme",
      "policy_id": "policy:nonexistent"
    }
  },
  "context": {
    "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242",
    "trace_id": "tr-123"
  }
}
```

## CAF Subjects

### Input: Exec Assignment

**Subject**: `caf.exec.assign.v1` (configurable via `assignment_subject`)

**Direction**: Router → CAF

**Message Format**: `ExecAssignment` (JSON)

**Description**: Router publishes execution assignments to CAF when `push_assignment: true` is set in DecideRequest.

**Example**:
```json
{
  "version": "1",
  "assignment_id": "a1234567890-12345",
  "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242",
  "executor": {
    "provider_id": "openai:gpt-4o",
    "channel": "nats"
  },
  "job": {
    "type": "text.generate",
    "payload_ref": "s3://bucket/key"
  },
  "options": {
    "priority": 50,
    "deadline_ms": 5000,
    "retry": {
      "max_attempts": 2,
      "backoff_ms": 200
    }
  },
  "correlation": {
    "trace_id": "tr-123"
  },
  "decision": {
    "provider_id": "openai:gpt-4o",
    "expected_latency_ms": 850,
    "expected_cost": 0.012,
    "reason": "best_score"
  },
  "metadata": {
    "user_id": "u-42"
  }
}
```

**Headers** (NATS/1.0 format):
```
NATS/1.0\r\n
trace_id: tr-123\r\n
traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\r\n
tenant_id: acme\r\n
version: 1\r\n
span_id: sp-456\r\n
X-Trace-Id: tr-123\r\n
X-Span-Id: sp-456\r\n
\r\n
```

**Header Description**:
- `trace_id`: Distributed tracing identifier (from `DecideRequest.trace_id`)
- `traceparent`: W3C Trace Context format for OpenTelemetry integration
- `tenant_id`: Multi-tenant isolation (from `DecideRequest.tenant_id`)
- `version`: Schema version (`"1"`)
- `span_id`: Current span identifier (generated by Router)
- `X-Trace-Id`, `X-Span-Id`: Compatibility headers

**Header Injection**:
- Headers are automatically injected by `router_caf_adapter.erl` when publishing assignments
- OpenTelemetry trace context is injected using `router_tracing:inject_trace_context/2`
- Headers enable end-to-end trace visibility in OpenTelemetry (Router → CAF → Result/ACK)

### Output: Exec Assignment ACK (Optional)

**Subject**: `caf.exec.assign.v1.ack`

**Direction**: CAF → Router

**Message Format**: `ExecAssignmentAck` (protobuf primary, JSON fallback for backward compatibility)

**Description**: CAF optionally publishes acknowledgment of assignment acceptance/rejection.

**Example (Accepted)**:
```json
{
  "assignment_id": "a1234567890-12345",
  "status": "accepted",
  "message": "Assignment queued for execution"
}
```

**Example (Rejected)**:
```json
{
  "assignment_id": "a1234567890-12345",
  "status": "rejected",
  "message": "Provider unavailable"
}
```

**Headers** (NATS/1.0 format, optional but recommended):
```
NATS/1.0\r\n
trace_id: tr-123\r\n
tenant_id: acme\r\n
version: 1\r\n
\r\n
```

**Header Extraction and Processing**:
- Router extracts `trace_id`, `tenant_id`, `version` from headers (priority) or payload (fallback)
- Headers are used for:
  - **Tenant Validation**: `tenant_id` validated against allowlist and policy registry
  - **Trace Context**: `trace_id` used to create OpenTelemetry spans with parent context
  - **NAK on Validation Errors**: If tenant validation fails, Router calls `router_nats:nak_message(MsgId)` for controlled redelivery (respects `MaxDeliver` configuration)
  - **Idempotency**: `assignment_id` used for idempotency checks (prevents duplicate ACK processing, TTL-based expiration)
  - **MaxDeliver Exhaustion**: Router tracks delivery count per message and emits `router_jetstream_maxdeliver_exhausted_total` metric when `delivery_count >= MaxDeliver`

### Output: Exec Result

**Subject**: `caf.exec.result.v1`

**Direction**: CAF → Router

**Message Format**: `ExecResult` (protobuf primary, JSON fallback for backward compatibility)

**Description**: CAF publishes execution results to this subject after job completion.

**Example (Success)**:
```json
{
  "assignment_id": "a1234567890-12345",
  "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242",
  "status": "success",
  "provider_id": "openai:gpt-4o",
  "job": {
    "type": "text.generate"
  },
  "latency_ms": 850,
  "cost": 0.012,
  "trace_id": "tr-123",
  "tenant_id": "acme",
  "timestamp": 1706371200000
}
```

**Headers** (NATS/1.0 format, optional but recommended):
```
NATS/1.0\r\n
trace_id: tr-123\r\n
tenant_id: acme\r\n
version: 1\r\n
\r\n
```

**Header Extraction**:
- Router extracts `trace_id`, `tenant_id`, `version` from headers (priority) or payload (fallback)
- Headers are used for:
  - **Tenant Validation**: `tenant_id` validated against allowlist and policy registry
  - **Trace Context**: `trace_id` used to create OpenTelemetry spans with parent context
  - **NAK on Validation Errors**: If tenant validation fails, Router calls `router_nats:nak_message(MsgId)` for controlled redelivery (respects `MaxDeliver` configuration)
  - **Idempotency**: `assignment_id`/`request_id` used for idempotency checks (prevents duplicate result processing and usage emission, TTL-based expiration)
  - **MaxDeliver Exhaustion**: Router tracks delivery count per message and emits `router_jetstream_maxdeliver_exhausted_total` metric when `delivery_count >= MaxDeliver`

**Example (Error)**:
```json
{
  "assignment_id": "a1234567890-12345",
  "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242",
  "status": "error",
  "provider_id": "openai:gpt-4o",
  "job": {
    "type": "text.generate"
  },
  "latency_ms": 200,
  "cost": 0.0,
  "trace_id": "tr-123",
  "tenant_id": "acme",
  "timestamp": 1706371200000
}
```

### Output: Usage Metering Event

**Subject**: `beamline.usage.v1.metered`

**Direction**: Router → Usage System

**Message Format**: Usage Event (JSON)

**Description**: Router publishes usage metering events after processing ExecResult.

**Example**:
```json
{
  "version": "1",
  "tenant_id": "acme",
  "provider_id": "openai:gpt-4o",
  "event_type": "text.generate",
  "latency_ms": 850,
  "cost": 0.012,
  "status": "success",
  "trace_id": "tr-123",
  "timestamp": 1706371200000,
  "assignment_id": "a1234567890-12345",
  "request_id": "e3b0c442-98fc-1c14-9afb-4c8996fb9242"
}
```

## Subject Configuration

### Router Configuration

Subjects can be configured via application environment:

```erlang
{beamline_router, [
    {nats_subject, <<"beamline.router.v1.decide">>},
    {nats_reply_subject, <<"beamline.router.v1.decide.reply">>},
    {caf_assignment_subject, <<"caf.exec.assign.v1">>}
]}
```

**Configuration Priority**:
1. **Request-level**: `DecideRequest.assignment_subject` (highest priority)
2. **Application environment**: `caf_assignment_subject` (default)
3. **Hardcoded default**: `"caf.exec.assign.v1"` (fallback)

### Default Subjects

- **Decide Request**: `beamline.router.v1.decide` (from `nats_subject` config)
- **Decide Response**: `beamline.router.v1.decide.reply` (reply-inbox pattern)
- **Exec Assignment**: `caf.exec.assign.v1` (from `caf_assignment_subject` config, configurable per request)
- **Exec Assignment ACK**: `caf.exec.assign.v1.ack` (optional, from CAF, configurable via `ack_subject`)
- **Exec Result**: `caf.exec.result.v1` (from CAF, configurable via `result_subject`)
- **Usage Metering**: `beamline.usage.v1.metered` (from Router, configurable via `usage_subject`)

### Subject Configuration Details

**DecideRequest.assignment_subject**:
- Can override default `caf_assignment_subject` per request
- Must be valid NATS subject format
- Used only when `push_assignment: true`

**Reply Subjects**:
- Router uses reply-inbox pattern: `{original_subject}.reply`
- Example: `beamline.router.v1.decide` → `beamline.router.v1.decide.reply`
- CAF should subscribe to reply subject or use reply-inbox in publish call
- **Exec Assignment ACK**: `caf.exec.assign.v1.ack`

## Request-Reply Pattern

Router uses NATS request-reply pattern:

1. CAF publishes `DecideRequest` to `beamline.router.v1.decide`
2. Router processes request and publishes `DecideResponse` to reply-inbox (or `beamline.router.v1.decide.reply`)
3. If `push_assignment: true`, Router additionally publishes `ExecAssignment` to `caf.exec.assign.v1`
4. CAF optionally publishes `ExecAssignmentAck` to `caf.exec.assign.v1.ack`
5. CAF publishes `ExecResult` to `caf.exec.result.v1` after job completion
6. Router processes `ExecResult`, correlates by `assignment_id`/`request_id`, and publishes usage event to `beamline.usage.v1.metered`

## Security Considerations

- **mTLS**: NATS connection should use mTLS for authentication
- **JWT**: Subject-based authentication via JWT tokens
- **Subject Whitelist**: Router should validate allowed subjects
- **Multi-tenancy**: `tenant_id` must be validated and enforced

## Versioning

Subject names include version (`v1`) to allow future evolution:
- `beamline.router.v1.*` - Version 1 protocol
- `beamline.router.v2.*` - Future version 2 protocol (backward compatible)

## Best Practices

See `docs/NATS_BEST_PRACTICES.md` for production-ready recommendations:
- JetStream durable consumers with `AckPolicy=Explicit`, `MaxDeliver`, and `Backoff`
- Queue groups for horizontal scaling
- Message headers for `trace_id`, `tenant_id`, `version`
- Payload size limits (≈1 MB default)
- Subject versioning and naming conventions
- **NAK Behavior**: Router calls `router_nats:nak_message(MsgId)` on tenant validation failures, triggering controlled redelivery up to `MaxDeliver` attempts
- **Idempotency**: Router uses ETS-based idempotency layer to prevent duplicate processing of results, ACKs, and usage events (configurable TTL via `idempotency_ttl_seconds`)
- **MaxDeliver Exhaustion Tracking**: Router tracks delivery count per message and emits `router_jetstream_maxdeliver_exhausted_total` metric when `delivery_count >= MaxDeliver`

## References

- `docs/API_CONTRACTS.md` - Message format specifications
- `docs/NATS_BEST_PRACTICES.md` - Production best practices and recommendations
- `src/router_nats_subscriber.erl` - Router NATS subscriber implementation
- `src/router_caf_adapter.erl` - CAF adapter implementation

