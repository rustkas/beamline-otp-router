# Router Test Environment

**Last Updated**: 2025-01-27  
**Purpose**: Guide for setting up and configuring the test environment for router tests

## Overview

The router test environment supports:
- **Fast unit tests** (< 1 minute)
- **Integration tests** (1-5 minutes)
- **E2E tests** (5-15 minutes)
- **Load tests** (15-60 minutes)
- **Property-based tests** (PropEr)

## Quick Start

### 1. Setup Test Environment

```bash
cd apps/otp/router
./scripts/setup_test_environment.sh
```

This script will:
- Check Erlang/OTP and rebar3 installation
- Verify test dependencies (PropEr, meck)
- Compile test build
- Create test directories
- Configure environment variables

### 2. Verify Environment

```bash
./scripts/check_test_environment.sh
```

This script verifies:
- All required dependencies are installed
- Test dependencies are compiled
- Test configuration files exist
- Test build compiles successfully

### 3. Run Tests

```bash
# Fast tests (smoke/contract tests)
./scripts/test_fast.sh

# Slow tests (load/E2E tests)
./scripts/test_slow.sh

# CP1 smoke tests
./scripts/test_cp1_smoke.sh

# Specific test suite
rebar3 ct --suite test/router_core_SUITE
```

## Requirements

### Required Dependencies

1. **Erlang/OTP 25+**
   ```bash
   # Check version
   erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell
   ```

2. **rebar3**
   ```bash
   # Install rebar3
   curl -L https://s3.amazonaws.com/rebar3/rebar3 -o rebar3
   chmod +x rebar3
   # Or use package manager
   ```

3. **Test Dependencies** (automatically fetched by rebar3):
   - `meck` - Mocking library
   - `proper` - Property-based testing

### Optional Dependencies

- **NATS Server** - For integration tests (if not using mock mode)
- **Docker** - For containerized tests
- **Docker Compose** - For multi-container test setups

## Configuration

### Environment Variables

Test environment can be configured via environment variables:

```bash
# NATS configuration
export NATS_MOCK_MODE=true          # Use mock NATS (default: true)
export NATS_URL=nats://localhost:4222  # NATS server URL (if not using mock)

# Telemetry configuration
export TELEMETRY_ENABLED=false      # Disable telemetry in tests (default: false)

# gRPC configuration
export GRPC_ENABLED=false           # Disable gRPC server in tests (default: false)
export GRPC_PORT=0                  # gRPC port (0 = disabled)

# Metrics configuration
export METRICS_PORT=9091            # Prometheus metrics port

# Erlang flags
export ERL_FLAGS="+K true +A 4"     # Kernel and async thread pool settings
```

### Test Configuration Files

1. **`rebar.config`** - Main rebar3 configuration
   - Test dependencies (meck, proper)
   - Test profile settings
   - Compilation options

2. **`config/test.config`** - Test application configuration
   - Application environment variables
   - Test-specific settings

3. **`ct.config`** - Common Test configuration (optional)
   - Test profiles (ci, heavy)
   - Test timeouts
   - Test data directories

4. **`.test_env`** - Test environment file (generated by setup script)
   - Current test environment variables
   - Can be sourced: `source .test_env`

## Test Profiles

### CI Profile (`ci`)

**Purpose**: Fast tests for CI/CD pipelines

**Configuration**:
- Profile: `ci`
- Load: 10 clients × 20 requests
- Timeout: ~5 minutes
- Suites: Fast test suites only

**Usage**:
```bash
rebar3 ct --suite test/router_circuit_breaker_SUITE --config ct.config --profile ci
```

### Heavy Profile (`heavy`)

**Purpose**: Extended load testing

**Configuration**:
- Profile: `heavy`
- Load: 50 clients × 100 requests
- Timeout: ~20-30 minutes
- Suites: All test suites including load tests

**Usage**:
```bash
rebar3 ct --suite test/router_publish_failure_e2e_SUITE --config ct.config --profile heavy
```

## Test Categories

### Fast Tests

**Execution Time**: < 1 minute  
**Purpose**: Quick validation of core functionality

**Test Suites**:
- `router_core_SUITE` - Core router functionality
- `router_e2e_smoke_SUITE` - E2E smoke tests
- `router_gateway_contract_smoke_SUITE` - Gateway contract tests
- `router_grpc_SUITE` - gRPC service tests
- `router_caf_adapter_unit_SUITE` - CAF adapter unit tests

**Run**:
```bash
./scripts/test_fast.sh
```

### Slow Tests

**Execution Time**: 1-60 minutes  
**Purpose**: Extended testing including load and E2E

**Test Suites**:
- `router_circuit_breaker_SUITE` - Circuit breaker tests
- `router_publish_failure_e2e_SUITE` - Publish failure E2E tests
- `router_jetstream_e2e_SUITE` - JetStream E2E tests
- `router_policy_applier_load_SUITE` - Policy applier load tests
- `router_extensions_pipeline_load_SUITE` - Extensions pipeline load tests

**Run**:
```bash
./scripts/test_slow.sh
```

### Property-Based Tests

**Execution Time**: < 1 minute  
**Purpose**: Validate invariants through random sequences

**Test Suites**:
- `router_circuit_breaker_prop_SUITE` - Circuit breaker invariants
- `router_policy_structure_prop_SUITE` - Policy structure properties
- `router_ets_consistency_prop_SUITE` - ETS consistency properties
- `router_decider_prop_SUITE` - Decider properties
- `router_normalize_boolean_prop_SUITE` - Boolean normalization properties

**Run**:
```bash
rebar3 ct --suite test/router_circuit_breaker_prop_SUITE
```

## Test Helpers

### `test_helpers.erl`

Common Test helper module providing:
- `wait_for_app_start/2` - Wait for application process
- `wait_for_condition/2` - Wait for condition to become true
- `wait_for_process/2` - Wait for process to be alive
- `wait_for_metric/4` - Wait for metric to be emitted
- `wait_for_log/4` - Wait for log entry
- `wait_for_ets_entry/4` - Wait for ETS entry
- `get_proper_options/0` - Get PropEr options from environment

### `router_test_utils.erl`

Router-specific test utilities:
- `start_router_app/0` - Start router application
- `stop_router_app/0` - Stop router application
- `ensure_circuit_breaker_alive/0` - Ensure circuit breaker is running
- `reset_circuit_breaker/0` - Reset circuit breaker state
- `wait_for_breaker_state/4` - Wait for circuit breaker state
- `wait_for_metric/3` - Wait for metric value

## Running Tests

### Run All Fast Tests

```bash
./scripts/test_fast.sh
```

### Run All Slow Tests

```bash
./scripts/test_slow.sh
```

### Run CP1 Smoke Tests

```bash
./scripts/test_cp1_smoke.sh
```

### Run Specific Test Suite

```bash
rebar3 ct --suite test/router_core_SUITE
```

### Run Specific Test Case

```bash
rebar3 ct --suite test/router_core_SUITE --case test_policy_parsing
```

### Run Tests with Profile

```bash
rebar3 ct --suite test/router_circuit_breaker_SUITE --config ct.config --profile ci
```

### Run Tests with Coverage

```bash
rebar3 ct --cover --suite test/router_core_SUITE
```

## Troubleshooting

### Test Environment Not Ready

**Problem**: `check_test_environment.sh` reports errors

**Solution**:
1. Run `./scripts/setup_test_environment.sh` to setup environment
2. Check error messages and install missing dependencies
3. Re-run `./scripts/check_test_environment.sh` to verify

### Compilation Errors

**Problem**: `rebar3 as test compile` fails

**Solution**:
1. Check Erlang/OTP version: `erl -version`
2. Update rebar3: `rebar3 update`
3. Clean and rebuild: `rebar3 clean && rebar3 as test compile`
4. Check for missing dependencies in `rebar.config`

### Test Timeouts

**Problem**: Tests timeout before completion

**Solution**:
1. Increase timeout in `ct.config`:
   ```erlang
   {timetrap, {minutes, 10}}
   ```
2. Check system resources (CPU, memory)
3. Use lighter test profile: `--profile ci`

### NATS Connection Errors

**Problem**: Tests fail with NATS connection errors

**Solution**:
1. Use mock NATS mode: `export NATS_MOCK_MODE=true`
2. Or start NATS server: `nats-server`
3. Check NATS URL: `export NATS_URL=nats://localhost:4222`

### PropEr Not Found

**Problem**: Property tests are skipped

**Solution**:
1. Install PropEr: `rebar3 as test get-deps`
2. Verify PropEr is in dependencies: `rebar3 as test tree | grep proper`
3. Recompile: `rebar3 as test compile`

## Test Results

### Test Output

Test results are written to:
- **Console**: Real-time test output
- **`test_results/`**: JUnit XML reports (if configured)
- **`test_logs/`**: Detailed test logs
- **`coverage/`**: Code coverage reports (if enabled)

### Viewing Test Logs

```bash
# View latest test log
ls -lt test_logs/ | head -1

# View specific test log
cat test_logs/router_core_SUITE.log
```

### Coverage Reports

```bash
# Generate coverage report
rebar3 ct --cover --suite test/router_core_SUITE

# View coverage report
open coverage/index.html  # macOS
xdg-open coverage/index.html  # Linux
```

## CI/CD Integration

### GitHub Actions

```yaml
- name: Setup test environment
  run: |
    cd apps/otp/router
    ./scripts/setup_test_environment.sh

- name: Run fast tests
  run: |
    cd apps/otp/router
    ./scripts/test_fast.sh
```

### GitLab CI

```yaml
test:fast:
  script:
    - cd apps/otp/router
    - ./scripts/setup_test_environment.sh
    - ./scripts/test_fast.sh
```

## Best Practices

1. **Always run `setup_test_environment.sh`** before first test run
2. **Use `check_test_environment.sh`** to verify environment before running tests
3. **Use appropriate test profile** (ci for fast tests, heavy for load tests)
4. **Clean test state** between runs if needed: `rebar3 clean`
5. **Check test logs** for detailed error information
6. **Use mock NATS** for unit tests to avoid external dependencies
7. **Enable telemetry only when needed** (slows down tests)

## References

- [Common Test Documentation](https://www.erlang.org/doc/apps/common_test/)
- [PropEr Documentation](https://proper-testing.github.io/)
- [meck Documentation](https://github.com/eproxus/meck)
- [rebar3 Documentation](https://www.rebar3.org/docs)

