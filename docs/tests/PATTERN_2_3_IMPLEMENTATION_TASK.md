# –ó–∞–¥–∞—á–∞: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ –ø–æ–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç–∞–º–∏ Pattern 2.4 ‚Äî Persistent NATS Latency + Intermittent Policy

**Pattern ID**: Pattern 2.4 (–≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)  
**Status**: üìã **TODO** (Not Started)  
**Priority**: Medium  
**Estimated Effort**: 2-3 weeks  
**Assignee**: TBD  
**Created**: 2025-11-30  
**Related Documents**: 
- `TRIPLE_FAULT_PATTERNS_CATALOG.md#pattern-24-persistent-nats-laglatency--intermittent-policy-changes`
- `R8_COVERAGE_MATRIX.md#pattern-24-persistent-nats-latency--intermittent-policy`
- `R8_EXTENDED_COVERAGE.md`
- `R8_SUMMARY.md`

---

## 1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- **–ü–∞—Ç—Ç–µ—Ä–Ω**: `Pattern 2.4 ‚Äî Persistent NATS Latency + Intermittent Policy Changes` (–≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏).

- **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å**: –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ `‚è≥ Future` –≤–æ –≤—Å–µ—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö:
  - `TRIPLE_FAULT_PATTERNS_CATALOG.md` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ (Pattern 2.4, —Å—Ç–∞—Ç—É—Å: ‚è≥ Future)
  - `R8_COVERAGE_MATRIX.md` ‚Äî –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ–∫—Ä—ã—Ç–∏—è (Pattern 2.4, —Å—Ç–∞—Ç—É—Å: ‚è≥ Future)
  - `R8_EXTENDED_COVERAGE.md` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (Pattern 2.3 –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏, —Å—Ç–∞—Ç—É—Å: Future)
  - `R8_SUMMARY.md` ‚Äî –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (Pattern 2.3 –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏, —Å—Ç–∞—Ç—É—Å: Future)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö (`R8_EXTENDED_COVERAGE.md`, `R8_SUMMARY.md`) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª –Ω—É–º–µ—Ä–∞—Ü–∏—é –Ω–∞ Pattern 2.3, –Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (`TRIPLE_FAULT_PATTERNS_CATALOG.md`, `R8_COVERAGE_MATRIX.md`) –ø–∞—Ç—Ç–µ—Ä–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ Pattern 2.4. –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è Pattern 2.4 –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.

### –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ NATS (JetStream) –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º–∏ (intermittent) —Å–±–æ—è–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∏/–æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∫–∞:

- –Ω–µ –æ–ø–∏—Å–∞–Ω–æ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã, –æ–∂–∏–¥–∞–Ω–∏—è),
- –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏,
- –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ fault injection.

### –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- **Fault Injection Module**: `router_nats_fault_injection.erl`
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: `{delay, Milliseconds}` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: `{intermittent, Fault, Probability}` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
  - –û–ø–µ—Ä–∞—Ü–∏–∏: `connect`, `publish`, `publish_with_ack`, `ack`, `nak`, `subscribe`
  - **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ**: –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ "persistent latency" (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏) –∏ "intermittent policy" (–ø—Ä–µ—Ä—ã–≤–∏—Å—Ç—ã—Ö —Å–±–æ–µ–≤ –ø–æ–ª–∏—Ç–∏–∫–∏)

---

## 2. –¶–µ–ª—å –∑–∞–¥–∞—á–∏

**–¶–µ–ª—å**: –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω `Pattern 2.4 (Persistent NATS Latency + Intermittent Policy)` –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω:

- –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª **–¥–ª–∏—Ç–µ–ª—å–Ω—É—é/–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É** —Å–æ–æ–±—â–µ–Ω–∏–π –≤ NATS,
- –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª **–ø—Ä–µ—Ä—ã–≤–∏—Å—Ç—É—é (intermittent) –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é/–æ—à–∏–±–∫–∏** –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É (policy/handler),
- –ø–æ–∑–≤–æ–ª—è–ª **–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ** –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥ —ç—Ç–∏–º –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–º,
- –±—ã–ª –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö/—Å—Ü–µ–Ω–∞—Ä–∏—è—Ö.

---

## 3. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 3.1. –§–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞

#### 3.1.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "Persistent NATS Latency"

**–ß—Ç–æ —ç—Ç–æ**: –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (RTT) –¥–ª—è –≤—Å–µ—Ö –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö NATS –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: `min_latency_ms` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100ms)
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: `max_latency_ms` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5000ms)
- **–ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: `base_latency_ms` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0ms, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏)
- **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: `duration_seconds` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60s, –∏–ª–∏ `infinity` –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏)
- **–û–ø–µ—Ä–∞—Ü–∏–∏**: —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞:
  - `publish` ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
  - `ack` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  - `nak` ‚Äî –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  - `consume` ‚Äî –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (JetStream)
  - `subscribe` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ JetStream consumer
  - `all` ‚Äî –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π/—Å—É–±—ä–µ–∫—Ç–æ–≤**:
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º NATS subject/stream/consumer group (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ subject pattern (–Ω–∞–ø—Ä–∏–º–µ—Ä, `beamline.router.v1.*`)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º `{delay, Milliseconds}` –≤ `router_nats_fault_injection.erl`
- –†–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ "persistent" —Ä–µ–∂–∏–º–∞ (–∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ü–∏—è–º –¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è)
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–ª—É—á–∞–π–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ `[min_latency_ms, max_latency_ms]`

#### 3.1.2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "Intermittent Policy"

**–ß—Ç–æ —ç—Ç–æ**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ (–ø—Ä–µ—Ä—ã–≤–∏—Å—Ç—ã–µ) —Å–±–æ–∏/–¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –ø–æ–ª–∏—Ç–∏–∫–∏ Router.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** (–∫–æ–Ω–∫—Ä–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø—Ä–æ–µ–∫—Ç—É):

1. **Router Policy Enforcement** (`router_policy.erl`):
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç–∫–∞–∑—ã –≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, drop vs retry, delay vs immediate)

2. **Retry Policy** (`router_retry.erl` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π):
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏ –≤ –ª–æ–≥–∏–∫–µ retry
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ retry (backoff, max_retries)

3. **Backoff Policy**:
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏ –≤ —Ä–∞—Å—á–µ—Ç–µ backoff
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ backoff (exponential, jitter)

4. **Tenant Validation Policy** (`router_tenant.erl`):
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç–∫–∞–∑—ã –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ tenant
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (allow vs deny)

5. **Rate Limiting Policy** (`router_rate_limit.erl`):
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏ –≤ rate limiting
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤/–∫–≤–æ—Ç

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **–ß–∞—Å—Ç–æ—Ç–∞ —Å–±–æ–µ–≤**: `failure_rate` (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å 0.0-1.0, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.3 = 30%)
- **–¢–∏–ø —Å–±–æ—è**: `failure_type`:
  - `error` ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{error, policy_failed}`)
  - `delay` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{delay, 2000}`)
  - `decision_change` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `allow` ‚Üí `deny`)
- **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: `duration_seconds` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60s, –∏–ª–∏ `infinity`)
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `policy_component` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `router_policy`, `retry_policy`, `tenant_validation`)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å `router_policy_fault_injection.erl` (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `router_nats_fault_injection.erl`)
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É fault injection –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å `{intermittent, Fault, Probability}` –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫

#### 3.1.3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞

**–û–±–Ω–æ–≤–∏—Ç—å**:
- `TRIPLE_FAULT_PATTERNS_CATALOG.md`:
  - –†–∞—Å—à–∏—Ä–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ Pattern 2.4 —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å `‚è≥ Future` –Ω–∞ `‚úÖ Implemented`
- `R8_COVERAGE_MATRIX.md`:
  - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.4 —Å `‚è≥ Future` –Ω–∞ `‚úÖ Covered`
  - –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–µ—Å—Ç—ã
- `R8_EXTENDED_COVERAGE.md`:
  - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.3 (–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏) / Pattern 2.4 (–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏) —Å `‚è≥ Future` –Ω–∞ `‚úÖ Covered`
  - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
- `R8_SUMMARY.md`:
  - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.3 (–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏) / Pattern 2.4 (–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏) —Å `‚è≥ Future` –Ω–∞ `‚úÖ Covered`

### 3.2. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã fault injection

#### 3.2.1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `router_nats_fault_injection.erl`

**–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏**:

```erlang
%% Enable persistent latency for NATS operations
-spec enable_persistent_latency(Operations :: [atom()] | all, 
                                 MinLatencyMs :: non_neg_integer(),
                                 MaxLatencyMs :: non_neg_integer(),
                                 DurationSeconds :: non_neg_integer() | infinity) -> ok.

%% Disable persistent latency
-spec disable_persistent_latency() -> ok.

%% Get current persistent latency configuration
-spec get_persistent_latency() -> {ok, Config} | {error, not_enabled}.
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ETS —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ persistent latency
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `should_fail/2` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ —Å–ø–∏—Å–∫–∞ `Operations`:
  - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ `[MinLatencyMs, MaxLatencyMs]`
  - –ü—Ä–∏–º–µ–Ω—è—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É —á–µ—Ä–µ–∑ `timer:sleep/1`
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å `DurationSeconds` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞—Ç—å –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏

#### 3.2.2. –°–æ–∑–¥–∞–Ω–∏–µ `router_policy_fault_injection.erl`

**–ù–æ–≤—ã–π –º–æ–¥—É–ª—å** (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `router_nats_fault_injection.erl`):

```erlang
-module(router_policy_fault_injection).

-export([enable_fault/2, disable_fault/1, clear_all_faults/0, should_fail/2, get_fault/1]).
-export([enable_intermittent_policy_fault/3, disable_intermittent_policy_fault/1]).

%% Enable intermittent fault for a policy component
-spec enable_intermittent_policy_fault(Component :: atom(),
                                       Fault :: term(),
                                       Probability :: float()) -> ok.

%% Disable intermittent fault for a policy component
-spec disable_intermittent_policy_fault(Component :: atom()) -> ok.
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- ETS —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è fault injection –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `{intermittent, Fault, Probability}` –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –º–æ–¥—É–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É `should_fail/2` –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏

#### 3.2.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –º–æ–¥—É–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏

**–ú–æ–¥—É–ª–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** (–∫–æ–Ω–∫—Ä–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø—Ä–æ–µ–∫—Ç—É):
- `router_policy.erl` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- `router_retry.erl` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º retry –ª–æ–≥–∏–∫–∏
- `router_tenant.erl` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π tenant
- `router_rate_limit.erl` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º rate limiting

**–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**:

```erlang
%% In router_policy.erl
apply_policy(Message, Context) ->
    %% Check for policy fault injection
    case code:is_loaded(router_policy_fault_injection) of
        {file, _} ->
            case router_policy_fault_injection:should_fail(router_policy, #{message => Message}) of
                {true, {error, Reason}} ->
                    {error, Reason};
                {true, {delay, Ms}} ->
                    timer:sleep(Ms),
                    apply_policy_internal(Message, Context);
                false ->
                    apply_policy_internal(Message, Context)
            end;
        false ->
            apply_policy_internal(Message, Context)
    end.
```

### 3.3. –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### 3.3.1. –ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

**–¢–µ—Å—Ç**: `test_pattern_2_4_persistent_latency_intermittent_policy_basic/1`

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
- NATS —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, +500ms –∫ base latency)
- –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ "–ª–æ–º–∞–µ—Ç—Å—è" (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–π 3-–π –∑–∞–ø—Ä–æ—Å –æ—Ç–≤–µ—Ä–≥–∞–µ—Ç—Å—è –∏–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
- –°–∏—Å—Ç–µ–º–∞:
  - –Ω–µ —Ç–µ—Ä—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º),
  - –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ—Ä—è–¥–∫–∞ (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ),
  - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã/—Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∏**:
- Process liveness: `is_process_alive/1` –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- Message semantics: –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (—Å —É—á–µ—Ç–æ–º redelivery)
- Metrics correctness: –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—Ä–∞–∂–∞—é—Ç –ø–æ–≤—ã—à–µ–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –∏ —Å–±–æ–∏ –ø–æ–ª–∏—Ç–∏–∫–∏
- No infinite loops: –Ω–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö retry loops

#### 3.3.2. –°—Ü–µ–Ω–∞—Ä–∏–π —Å –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–µ–π

**–¢–µ—Å—Ç**: `test_pattern_2_4_degradation_scenario/1`

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
- –ü—Ä–∏ —Ä–æ—Å—Ç–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —Å–±–æ—è—Ö –ø–æ–ª–∏—Ç–∏–∫–∏:
  - –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è fallback-–º–µ—Ö–∞–Ω–∏–∑–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å),
  - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ç–∞–π–º–∞—É—Ç–∞–º/—Ä–µ—Ç—Ä–∞—è–º,
  - –º–µ—Ç—Ä–∏–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã –æ—Ç—Ä–∞–∂–∞—é—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é

**–ü—Ä–æ–≤–µ—Ä–∫–∏**:
- Fallback mechanisms: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ fallback (–Ω–∞–ø—Ä–∏–º–µ—Ä, default route –ø—Ä–∏ —Å–±–æ–µ –ø–æ–ª–∏—Ç–∏–∫–∏)
- Timeout handling: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
- Retry limits: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ retry
- Metrics degradation: –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `router_nats_pending_operations_count`)

#### 3.3.3. –°—Ü–µ–Ω–∞—Ä–∏–π —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º

**–¢–µ—Å—Ç**: `test_pattern_2_4_recovery_scenario/1`

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
- –ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è fault injection:
  - NATS –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞,
  - –ø–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç "—Ñ–ª–∞–ø–∞—Ç—å",
  - —Å–∏—Å—Ç–µ–º–∞ –≤—ã—Ö–æ–¥–∏—Ç –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ "–∑–∞–ª–∏–ø—à–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π/—Ç–∞—Å–∫–æ–≤/–ª–æ–∫–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∏**:
- Latency recovery: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–µ
- Policy recovery: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–ª–∏—Ç–∏–∫–∏
- No stuck messages: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è "–∑–∞–ª–∏–ø—à–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π
- State consistency: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

#### 3.3.4. –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

**–¢–µ—Å—Ç**: `test_pattern_2_4_high_traffic/1`

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –í—ã—Å–æ–∫–∏–π —Ç—Ä–∞—Ñ–∏–∫ + Pattern 2.4

**–ü—Ä–æ–≤–µ—Ä–∫–∏**:
- System stability: —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
- No resource leaks: –Ω–µ—Ç —É—Ç–µ—á–µ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ (–ø–∞–º—è—Ç—å, –ø—Ä–æ—Ü–µ—Å—Å—ã)
- Metrics accuracy: –º–µ—Ç—Ä–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ—á–Ω—ã–º–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

**–¢–µ—Å—Ç**: `test_pattern_2_4_component_restart/1`

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∏**:
- Graceful restart: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- No message loss: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ—Ç–µ—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- State recovery: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### 3.4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω

#### 3.4.1. –¢–µ—Å—Ç–æ–≤—ã–π suite

**–§–∞–π–ª**: `apps/otp/router/test/router_pattern_2_4_latency_policy_SUITE.erl`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```erlang
-module(router_pattern_2_4_latency_policy_SUITE).

-include_lib("common_test/include/ct.hrl").

-export([all/0, init_per_suite/1, end_per_suite/1]).
-export([test_pattern_2_4_persistent_latency_intermittent_policy_basic/1,
         test_pattern_2_4_degradation_scenario/1,
         test_pattern_2_4_recovery_scenario/1,
         test_pattern_2_4_high_traffic/1,
         test_pattern_2_4_component_restart/1]).
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:
- –î–æ–±–∞–≤–∏—Ç—å –≤ `rebar.config` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Ç–µ—Å—Ç–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ –¥–ª—è –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `pattern_2_4`, `latency_policy`)

#### 3.4.2. CI-–ø–∞–π–ø–ª–∞–π–Ω

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:
- –î–æ–±–∞–≤–∏—Ç—å –≤ `.github/workflows/` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π CI –∫–æ–Ω—Ñ–∏–≥
- –ó–∞–ø—É—Å–∫–∞—Ç—å –≤ nightly / extended suite (–µ—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω —Ç—è–∂–µ–ª—ã–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
- –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ç–µ–≥–∏

**–ü—Ä–∏–º–µ—Ä**:
```yaml
# .github/workflows/router-fault-injection-tests.yml
- name: Run Pattern 2.4 Tests
  run: |
    rebar3 ct --suite router_pattern_2_4_latency_policy_SUITE \
      --case test_pattern_2_4_persistent_latency_intermittent_policy_basic
  env:
    PATTERN_2_4_ENABLED: true
```

### 3.5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### 3.5.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–§–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**:
1. `TRIPLE_FAULT_PATTERNS_CATALOG.md`:
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.4 —Å `‚è≥ Future` –Ω–∞ `‚úÖ Implemented`
   - –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–µ—Å—Ç—ã

2. `R8_COVERAGE_MATRIX.md`:
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.4 —Å `‚è≥ Future` –Ω–∞ `‚úÖ Covered`
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–µ—Å—Ç—ã: `router_pattern_2_4_latency_policy_SUITE`

3. `R8_EXTENDED_COVERAGE.md`:
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.3 (–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏) / Pattern 2.4 (–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏) —Å `‚è≥ Future` –Ω–∞ `‚úÖ Covered`
   - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

4. `R8_SUMMARY.md`:
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å Pattern 2.3 (–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏) / Pattern 2.4 (–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏) —Å `‚è≥ Future` –Ω–∞ `‚úÖ Covered`

#### 3.5.2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–§–∞–π–ª**: `apps/otp/router/test/PATTERN_2_4_USAGE_GUIDE.md`

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ**:
- –û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
- –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
- –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- Troubleshooting

---

## 4. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

### 4.1. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ï—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å Persistent NATS Latency + Intermittent Policy
- ‚úÖ –í—Å–µ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤—ã—à–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏ –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ (–±–µ–∑ —Ñ–ª–∞–∫–∏)
- ‚úÖ –¢–µ—Å—Ç—ã –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω—ã (–ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π)

### 4.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- ‚úÖ Pattern 2.4 –≤—Å—Ç—Ä–æ–µ–Ω –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é fault injection –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–µ –ª–æ–º–∞–µ—Ç –¥—Ä—É–≥–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- ‚úÖ –ï—Å—Ç—å —Ñ–ª–∞–≥/—Ç–µ–≥/–∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–º–µ–Ω–Ω–æ Pattern 2.4
- ‚úÖ –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ CI-–ø–∞–π–ø–ª–∞–π–Ω (nightly / extended suite)

### 4.3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- ‚úÖ –í—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ Pattern 2.4 –±—ã–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ `Future`, –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –ï—Å—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω `PATTERN_2_4_USAGE_GUIDE.md` —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫–∞

### 4.4. –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

- ‚úÖ –í–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã –º–µ—Ç—Ä–∏–∫–∏/–ª–æ–≥–∏, –ø–æ–∑–≤–æ–ª—è—é—â–∏–µ —è–≤–Ω–æ —É–≤–∏–¥–µ—Ç—å:
  - –ø–æ–≤—ã—à–µ–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É NATS (–º–µ—Ç—Ä–∏–∫–∏ `router_nats_*_latency_*` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ)
  - –∏–Ω—Ç–µ—Ä–º–∏—Ç—Ç–∏—Ä—É—é—â–∏–µ –æ—Ç–∫–∞–∑—ã/–∞–Ω–æ–º–∞–ª–∏–∏ –≤ –ø–æ–ª–∏—Ç–∏–∫–µ (–º–µ—Ç—Ä–∏–∫–∏ `router_policy_*_failures_total` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ)
  - —Ä–µ–∞–∫—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã (–º–µ—Ç—Ä–∏–∫–∏ redelivery, timeout, retry)

---

## 5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ, –Ω–æ –∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ)

### 5.1. –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º–æ—Å—Ç—å

- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å:
  - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –≤–µ–ª–∏—á–∏–Ω—É –∑–∞–¥–µ—Ä–∂–∫–∏ (min/max latency)
  - —á–∞—Å—Ç–æ—Ç—É intermittent-—Å–±–æ–µ–≤ (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
  - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ—Ç–æ–∫–æ–≤/subject'–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω

### 5.2. –ü–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å

- ‚úÖ –ü—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö fault injection —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω (–º–∏–Ω–∏–º—É–º —Ñ–ª–∞–∫–∏)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ seed –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

### 5.3. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

- ‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–∏—Ç–∏–∫
- ‚úÖ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ fault injection –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## 6. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### 6.1. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å `router_nats_fault_injection.erl`
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ (–∫–æ–Ω–∫—Ä–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø—Ä–æ–µ–∫—Ç—É)
- –¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Common Test)

### 6.2. –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

- **–§–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞**: 1-2 –¥–Ω—è
- **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ fault injection –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: 3-5 –¥–Ω–µ–π
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤**: 5-7 –¥–Ω–µ–π
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω**: 1-2 –¥–Ω—è
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: 2-3 –¥–Ω—è
- **–ò—Ç–æ–≥–æ**: 2-3 –Ω–µ–¥–µ–ª–∏

### 6.3. –†–∏—Å–∫–∏

- **–§–ª–∞–∫–∏ —Ç–µ—Å—Ç–æ–≤**: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤
- **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ç–µ—Å—Ç—ã**: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å Pattern 2.3 –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –¢–µ—Å—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Ç—è–∂–µ–ª—ã–º–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å)

---

## 7. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **Review –∑–∞–¥–∞—á–∏**: –ü—Ä–æ–≤–µ—Å—Ç–∏ review –∑–∞–¥–∞—á–∏ —Å –∫–æ–º–∞–Ω–¥–æ–π
2. **–£—Ç–æ—á–Ω–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–ª–∏—Ç–∏–∫–∏**: –ö–æ–Ω–∫—Ä–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –º–æ–¥—É–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –±—É–¥—É—Ç –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
3. **–°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É**: `feature/pattern-2-4-latency-policy`
4. **–ù–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é**: –°–ª–µ–¥–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–∫—É —Ä–∞–∑–¥–µ–ª–æ–≤ 3.1-3.5

---

## 8. –°—Å—ã–ª–∫–∏

- **–ö–∞—Ç–∞–ª–æ–≥ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤**: `apps/otp/router/test/TRIPLE_FAULT_PATTERNS_CATALOG.md#pattern-24-persistent-nats-laglatency--intermittent-policy-changes`
- **–ú–∞—Ç—Ä–∏—Ü–∞ –ø–æ–∫—Ä—ã—Ç–∏—è**: `apps/otp/router/test/R8_COVERAGE_MATRIX.md#pattern-24-persistent-nats-latency--intermittent-policy`
- **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ**: `apps/otp/router/test/R8_EXTENDED_COVERAGE.md`
- **Fault Injection Module**: `apps/otp/router/src/router_nats_fault_injection.erl`
- **Fault Injection Tests**: `apps/otp/router/test/router_jetstream_fault_injection_SUITE.erl`

---

**Last Updated**: 2025-11-30  
**Status**: üìã TODO (Not Started)

