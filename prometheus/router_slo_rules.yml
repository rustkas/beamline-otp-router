groups:
  - name: router_slo_recording_rules
    interval: 30s
    rules:
      # ========================================
      # Latency SLI - p95 (5-minute window)
      # ========================================
      - record: slo:router_latency_p95:5m
        expr: |
          histogram_quantile(0.95,
            sum(rate(router_grpc_request_duration_seconds_bucket{method="decide"}[5m])) by (le)
          )
        labels:
          slo_type: "latency"
          quantile: "p95"

      # ========================================
      # Latency SLI - p99 (5-minute window)
      # ========================================
      - record: slo:router_latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(router_grpc_request_duration_seconds_bucket{method="decide"}[5m])) by (le)
          )
        labels:
          slo_type: "latency"
          quantile: "p99"

      # ========================================
      # Error Rate SLI (5-minute window)
      # ========================================
      - record: slo:router_error_rate:5m
        expr: |
          sum(rate(router_grpc_requests_total{method="decide",status!="success"}[5m]))
          /
          sum(rate(router_grpc_requests_total{method="decide"}[5m]))
        labels:
          slo_type: "availability"

      # ========================================
      # Success Rate SLI (5-minute window)
      # ========================================
      - record: slo:router_success_rate:5m
        expr: |
          sum(rate(router_grpc_requests_total{method="decide",status="success"}[5m]))
          /
          sum(rate(router_grpc_requests_total{method="decide"}[5m]))
        labels:
          slo_type: "availability"

      # ========================================
      # Availability (30-day rolling window)
      # ========================================
      - record: slo:router_availability:30d
        expr: |
          sum(increase(router_grpc_requests_total{method="decide",status="success"}[30d]))
          /
          sum(increase(router_grpc_requests_total{method="decide"}[30d]))
        labels:
          slo_type: "availability"
          window: "30d"

      # ========================================
      # Error Budget Remaining (30-day window)
      # SLO target: 99.9% availability
      # Error budget: 0.1% (0.001)
      # ========================================
      - record: slo:router_error_budget_remaining:30d
        expr: |
          1 - (
            (1 - slo:router_availability:30d)
            /
            0.001
          )
        labels:
          slo_type: "error_budget"
          slo_target: "99.9"

      # ========================================
      # Error Budget Burn Rate (1-hour window)
      # ========================================
      - record: slo:router_error_budget_burn_rate:1h
        expr: |
          (1 - slo:router_success_rate:5m) / 0.001
        labels:
          slo_type: "error_budget"
          window: "1h"

      # ========================================
      # Total Requests (5-minute rate)
      # ========================================
      - record: slo:router_requests_total:5m
        expr: |
          sum(rate(router_grpc_requests_total{method="decide"}[5m]))
        labels:
          slo_type: "throughput"
