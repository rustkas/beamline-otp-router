{deps, [
    {grpcbox, "~> 0.17.1"},
    {jsx, "~> 3.0"},
    {telemetry, "~> 1.0"},
    {opentelemetry_api, "~> 1.3"},  %% OpenTelemetry API for distributed tracing
    {enats, {git, "https://github.com/willemdj/erlang-nats.git", {tag, "v1.2.0"}}},
    {meck, "0.9.2"}
]}.

{project_apps, [
    "apps/beamline_router",
    "apps/router_control_api"
]}.

%% Coverage configuration
%% Cover is enabled only when explicitly requested with: rebar3 ct --cover
%% Default disabled to avoid compilation overhead
{cover_enabled, false}.
{cover_opts, [verbose]}.

{plugins, [
    rebar3_gpb_plugin
]}.

{gpb_opts, [
    %% Include paths: proto files are in root proto/ directory
    %% Single source of truth: proto/beamline/flow/v1/flow.proto
    {i, ["proto"]},
    {o_erl, "apps/beamline_router/src"},
    {o_hrl, "apps/beamline_router/include"},
    {module_name_suffix, "_pb"},
    {strings_as_binaries, true},
    {file_suffix, "_pb"},
    {recursive, true},
    %% Suppress warnings for unused helper functions in generated code
    {erlc_compile_opts, [nowarn_unused_function]}
]}.

{provider_hooks, [
    {pre, [
        {compile, {protobuf, compile}},
        {clean, {protobuf, clean}}
    ]},
    {ct, [
        {shell, "bash scripts/lint/check_ct_suite_structure.sh"}
    ]}
]}.

{erl_opts, [
  debug_info,
  warn_export_all,
  warn_unused_import,
  {i, ["apps/beamline_router/include"]},
  {warnings_as_errors, false},  %% Allow warnings in test compilation
  {d, 'CP2'}  %% Enable CP2 features (required for router_admin_grpc)
]}.

%% Note: *_pb.erl files are auto-generated by gpb and may contain unused helper functions.
%% This is expected and harmless - gpb generates all possible protobuf type encoders even if not used.



{ct_opts, [
    {sys_config, "config/test.config"}
]}.

{shell, [
    {apps, [beamline_router]}
]}.

{dialyzer, [
    {plt_apps, all_deps},
    {get_warnings, true},
    {warnings, [unmatched_returns, no_return, unknown]},
    {plt_location, file, "_build/default/dialyzer.plt"},
    {ignore_warnings, "dialyzer.ignore-warnings"}
]}.

{alias, [
    {check, [compile, xref, eunit, ct, dialyzer]},
    {ct_all, [ct]},
    %% CP1 core quick run - runs essential CP1 suites for fast CI feedback
    {ct_cp1, [{ct, "--suite=router_cp1_smoke_SUITE,router_cp1_red_bar_SUITE,router_core_basic_SUITE,router_policy_SUITE,router_policy_store_SUITE,router_error_SUITE,router_mock_helpers_SUITE,router_test_init_SUITE,router_nats_publish_fail_open_SUITE,router_core_telemetry_contract_SUITE,router_cp1_default_env_SUITE"}]},
    %% CP1 stability gate - run router_cp1_order_runner with repeat/random checks
    %% Usage: rebar3 as test shell --eval "router_cp1_order_runner:repeat_run(3)."
    %% Or: rebar3 as test shell --eval "router_cp1_order_runner:run(3)."
    {ct_cp1_stability, [{ct, "--suite=router_cp1_smoke_SUITE,router_cp1_red_bar_SUITE,router_core_basic_SUITE,router_mock_helpers_SUITE,router_test_init_SUITE"}]},
    %% CP1 randomized order runner (Task 9)
    %% Usage: rebar3 as test ct_cp1_rand
    %% Runs CP1 suites in random order 3 times, exits non-zero on failure
    {ct_cp1_rand, [
        {shell, "--eval 'case router_cp1_order_runner:run(3) of ok -> halt(0); _ -> halt(1) end.'"}
    ]},
    %% CP1 repeat runner (Task 8)
    %% Usage: rebar3 as test ct_cp1_repeat
    %% Runs CP1 suites in fixed order 3 times, exits non-zero on failure
    {ct_cp1_repeat, [
        {shell, "--eval 'case router_cp1_order_runner:repeat_run(3) of ok -> halt(0); _ -> halt(1) end.'"}
    ]},
    %% Deterministic baseline: fast local/CI signal (no heavy/perf/chaos)
    {deterministic, [
        {shell, "--eval 'os:cmd(\"bash scripts/lint/check_ct_quarantine_consistency.sh\"); halt(0).'"},
        {ct, "--suite=router_result_consumer_core_SUITE,router_result_consumer_faults_SUITE,router_decide_consumer_core_SUITE,router_decide_consumer_faults_SUITE,router_decide_consumer_unit_SUITE --readable=true --retry"}
    ]}
]}.

%% Xref configuration: focus on correctness checks, skip unused export noise
{xref_checks,[
    undefined_function_calls,
    undefined_functions,
    deprecated_function_calls,
    deprecated_functions
]}.

%% Ignore known optional integrations to keep xref clean
{xref_ignores, [
    {epgsql, connect, 4},
    {epgsql, equery, 3},
    {worker_pb, decode_msg, 2},
    {otel_status, set_status, 2},
    {otel_status, status, 2},
    {otel_span, span_span_id, 1},
    {otel_span, span_trace_id, 1}
]}.

%% Test dependencies (PropEr for property-based testing)
{profiles, [
  {prod, [
    {erl_opts, [no_debug_info, warnings_as_errors]}
  ]},
  {test, [
    {deps, [
      {meck, "~> 0.9"},
      {proper, "~> 1.4"},  %% Property-based testing: proper.hrl always included in test profile
      %% Note: cth_surefire can be added manually if needed for JUnit reports
      %% {cth_surefire, "~> 2.0"}  %% JUnit reporter for CI/CD integration
      {eqwalizer_support,
        {git_subdir,
          "https://github.com/whatsapp/eqwalizer.git",
          {branch, "main"},
          "eqwalizer_support"}}
    ]},
    {env, [
      {beamline_router, [
        {disable_heir, true},
        {telemetry_enabled, false}  %% Minimize telemetry in tests for faster execution
      ]}
    ]},
    {erl_opts, [nowarn_unused_function, {d, 'CP2'}, {d, 'TEST'}]},
    {extra_src_dirs, ["test_support", "test/test_utils"]},
    %% Cover is explicitly enabled when --cover flag is passed
    %% No need to disable here - rebar3 handles this automatically
    {ct_opts, [
      {sys_config, "config/test.config"},
      {ct_hooks, [cth_test_deps]},
      {num_concurrent_suites, 1}
    ]}
  ]},
  {deterministic, [
    {erl_opts, [nowarn_unused_function, {d, 'CP2'}, {d, 'TEST'}]},
    {extra_src_dirs, ["test_support", "test/test_utils"]},
    {ct_opts, [
      {sys_config, "config/test.config"},
      {suite, [
        router_result_consumer_core_SUITE,
        router_result_consumer_faults_SUITE,
        router_decide_consumer_core_SUITE,
        router_decide_consumer_faults_SUITE,
        router_decide_consumer_unit_SUITE
      ]},
      {readable, true}
    ]}
    ,
    {alias, [
      %% Override 'ct' in deterministic profile to run lint gate then baseline suites only
      {ct, [
        {shell, "bash scripts/lint/check_ct_quarantine_consistency.sh"},
        {ct, "--readable=true --retry"}
      ]}
    ]}
  ]},
  {dev_control, [
    {shell, [
      {apps, [beamline_router, router_control_api]}
    ]}
  ]},
    {ci, [
        {dialyzer, [
            {plt_apps, all_deps},
            {get_warnings, true},
            {warnings, [unmatched_returns, no_return, unknown]},
            {plt_location, local},
            {output_format, raw},
            {ignore_warnings, "dialyzer.ignore-warnings"}
        ]}
    ]}
]}.
