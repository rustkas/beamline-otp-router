{deps, [
    {grpcbox, "~> 0.17.1"},
    {jsx, "~> 3.0"},
    {telemetry, "~> 1.0"},
    {opentelemetry_api, "~> 1.3"}  %% OpenTelemetry API for distributed tracing
    %% Note: NATS client implemented directly in router_nats.erl (no external dependency)
]}.

%% Coverage configuration
%% Cover is enabled only when explicitly requested with: rebar3 ct --cover
%% Default disabled to avoid compilation overhead
{cover_enabled, false}.
{cover_opts, [verbose]}.

{plugins, [
    rebar3_gpb_plugin
]}.

{gpb_opts, [
    %% Include paths: proto files are in root proto/ directory
    %% Single source of truth: proto/beamline/flow/v1/flow.proto
    {i, ["proto"]},
    {o_erl, "src"},
    {o_hrl, "include"},
    {module_name_suffix, "_pb"},
    {strings_as_binaries, true},
    {file_suffix, "_pb"},
    {recursive, true}
]}.

{provider_hooks, [
    {pre, [
        {compile, {protobuf, compile}},
        {clean, {protobuf, clean}}
    ]}
]}.

{erl_opts, [
  debug_info,
  warn_export_all,
  warn_unused_import,
  {i, ["include", "_build/default/plugins/gpb/include"]},
  {warnings_as_errors, false},  %% Allow warnings in test compilation
  {d, 'CP2'}  %% Enable CP2 features (required for router_admin_grpc)
]}.

%% Exclude test files from compilation (they should only be compiled by Common Test)
%% This prevents test files from being compiled to ebin/ and causing cover issues
{src_dirs, ["src"]}.


{ct_opts, [
    {sys_config, "config/test.config"}
]}.

{shell, [
    {apps, [beamline_router]}
]}.

{dialyzer, [
    {plt_apps, all_deps},
    {get_warnings, true},
    {warnings, [unmatched_returns, no_return, unknown]},
    {plt_location, file, "_build/default/dialyzer.plt"},
    {ignore_warnings, "dialyzer.ignore-warnings"}
]}.

{alias, [
    {check, [compile, xref, eunit, ct, dialyzer]},
    {ct_all, [ct]},
    %% CP1 core quick run - runs essential CP1 suites for fast CI feedback
    {ct_cp1, [{ct, "--suite=router_cp1_smoke_SUITE,router_cp1_red_bar_SUITE,router_core_basic_SUITE,router_policy_SUITE,router_policy_store_SUITE,router_error_SUITE,router_mock_helpers_SUITE,router_test_init_SUITE,router_nats_publish_fail_open_SUITE,router_core_telemetry_contract_SUITE,router_cp1_default_env_SUITE"}]},
    %% CP1 stability gate - run router_cp1_order_runner with repeat/random checks
    %% Usage: rebar3 as test shell --eval "router_cp1_order_runner:repeat_run(3)."
    %% Or: rebar3 as test shell --eval "router_cp1_order_runner:run(3)."
    {ct_cp1_stability, [{ct, "--suite=router_cp1_smoke_SUITE,router_cp1_red_bar_SUITE,router_core_basic_SUITE,router_mock_helpers_SUITE,router_test_init_SUITE"}]},
    %% CP1 randomized order runner (Task 9)
    %% Usage: rebar3 as test ct_cp1_rand
    %% Runs CP1 suites in random order 3 times, exits non-zero on failure
    {ct_cp1_rand, [
        {shell, "--eval 'case router_cp1_order_runner:run(3) of ok -> halt(0); _ -> halt(1) end.'"}
    ]},
    %% CP1 repeat runner (Task 8)
    %% Usage: rebar3 as test ct_cp1_repeat
    %% Runs CP1 suites in fixed order 3 times, exits non-zero on failure
    {ct_cp1_repeat, [
        {shell, "--eval 'case router_cp1_order_runner:repeat_run(3) of ok -> halt(0); _ -> halt(1) end.'"}
    ]}
]}.

%% Xref configuration: focus on correctness checks, skip unused export noise
{xref_checks,[
    undefined_function_calls,
    undefined_functions,
    deprecated_function_calls,
    deprecated_functions
]}.

%% Ignore known optional integrations to keep xref clean
{xref_ignores, [
    {epgsql, connect, 4},
    {epgsql, equery, 3},
    {worker_pb, decode_msg, 2},
    {otel_status, set_status, 2},
    {otel_status, status, 2},
    {otel_span, span_span_id, 1},
    {otel_span, span_trace_id, 1}
]}.

%% Test dependencies (PropEr for property-based testing)
{profiles, [
  {prod, [
    {erl_opts, [no_debug_info, warnings_as_errors]}
  ]},
  {test, [
    {deps, [
      {meck, "~> 0.9"},
      {proper, "~> 1.4"}  %% Property-based testing: proper.hrl always included in test profile
      %% Note: cth_surefire can be added manually if needed for JUnit reports
      %% {cth_surefire, "~> 2.0"}  %% JUnit reporter for CI/CD integration
    ]},
    {env, [
      {beamline_router, [
        {disable_heir, true},
        {telemetry_enabled, false}  %% Minimize telemetry in tests for faster execution
      ]}
    ]},
    {erl_opts, [nowarn_unused_function, {d, 'CP2'}, {d, 'TEST'}]},
    {erlc_paths, ["src", "test", "test_support"]},
    %% Cover is explicitly enabled when --cover flag is passed
    %% No need to disable here - rebar3 handles this automatically
    {ct_opts, [
      {sys_config, "config/test.config"},
      {ct_hooks, [cth_test_deps]}
    ]}
  ]},
    {ci, [
        {dialyzer, [
            {plt_apps, all_deps},
            {get_warnings, true},
            {warnings, [unmatched_returns, no_return, unknown]},
            {plt_location, local},
            {output_format, raw},
            {ignore_warnings, "dialyzer.ignore-warnings"}
        ]}
    ]}
]}.
