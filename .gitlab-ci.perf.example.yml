# GitLab CI Performance Gate Integration Example
# Add this to your existing .gitlab-ci.yml

stages:
  - test
  - perf

perf_gate_cp1:
  stage: perf
  image: erlang:27
  allow_failure: false
  retry:
    max: 1
    when:
      - runner_system_failure
      - unknown_failure
      - stuck_or_timeout_failure
  variables:
    CT_TIMEOUT_SECONDS: "900"
    WARMUP_ENABLED: "1"
    WARMUP_TIMEOUT_SECONDS: "300"
  script:
    - chmod +x scripts/perf_gate.sh scripts/bench_router.sh scripts/nats_start.sh scripts/nats_stop.sh scripts/nats_status.sh || true
    - ./scripts/perf_gate.sh
  artifacts:
    when: always
    expire_in: 14 days
    paths:
      - _artifacts/
      - perf/baseline_cp1.json
      - perf/policy_cp1.json
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# Optional: separate smoke vs gate jobs
# 
# perf_smoke:
#   extends: perf_gate_cp1
#   allow_failure: true  # Informational only
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#
# perf_gate:
#   extends: perf_gate_cp1
#   allow_failure: false  # Blocking
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "main"'
#     - if: '$CI_PIPELINE_SOURCE == "schedule"'
